# Building a multi-cluster Istio mesh in Kubernetes

The [Istio/Install Multi-Primary on different network example](https://istio.io/latest/docs/setup/install/multicluster/multi-primary_multi-network/) is about to form an Istio mesh on top of two kubernetes clusters.

![caption](./service-mesh-k8s.gif)

### Install Istio [Istio - Getting Started](https://istio.io/latest/docs/setup/getting-started/)

```
curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.1 sh -
sudo rm /usr/local/bin/istioctl
sudo ln -s `pwd`/istio-1.10.1/bin/istioctl /usr/local/bin/istioctl
```

### Merge cluster1 and cluster2 kubeconfig

- Merge two cluster kubeconfig

```
export KUBECONFIG=cluster1-kubeconfig:cluster2-kubeconfig
kubectl config view
kubectl config view --raw > merge-config
```

- Get the contexts

```kubectl config get-contexts```

- Set up environment variables to use the contexts

```
export CTX_CLUSTER1=$(kubectl config view -o jsonpath='{.contexts[0].name}')
export CTX_CLUSTER2=$(kubectl config view -o jsonpath='{.contexts[1].name}')
echo CTX_CLUSTER1 = ${CTX_CLUSTER1}, CTX_CLUSTER2 = ${CTX_CLUSTER2}
```

### Create common Root CA and intermediate CA for cluster1/2 [Istio - Plug in CA Certificates](https://istio.io/latest/docs/tasks/security/cert-management/plugin-ca-cert/)

A Root CA: As Istio requires an mTLS connection between services running on separate clusters, you need to use a shared Root CA to generate intermediate CA certs for both clusters. That establishes trust between microservices running on different clusters as the intermediate certs share the same Root CA.

 have to create two intermediate CAs and import them as a secret into the istio-system namespace in both clusters before installing Istio. Both intermediate CAs share a common root CA, which makes both clusters trust each other. In a multi-cluster Istio mesh, all clusters must be trusted with each other to establish cross-cluster connections.

As we need to boot our Istio service mesh with intermediate certs generated by a shared root cert, create a secret using the intermediate certs.

- Create top Root CA cert and key

```
mkdir -p ~/istio-certs
cd istio-certs
make -f ~/istio-1.10.1/tools/certs/Makefile.selfsigned.mk root-ca
make -f ~/istio-1.10.1/tools/certs/Makefile.selfsigned.mk cluster1-cacerts
make -f ~/istio-1.10.1/tools/certs/Makefile.selfsigned.mk cluster2-cacerts
```

- Create cluster1 intermediate CA cert and key

```
kubectl create namespace istio-system --context ${CTX_CLUSTER1}
kubectl create secret generic cacerts \
    --context ${CTX_CLUSTER1} \
    -n istio-system \
    --from-file=cluster1/ca-cert.pem \
    --from-file=cluster1/ca-key.pem \
    --from-file=cluster1/root-cert.pem \
    --from-file=cluster1/cert-chain.pem
```

- Create cluster1 intermediate CA cert and key

```
kubectl create namespace istio-system --context ${CTX_CLUSTER2}
kubectl create secret generic cacerts \
    --context ${CTX_CLUSTER2} \
    -n istio-system \
    --from-file=cluster2/ca-cert.pem \
    --from-file=cluster2/ca-key.pem \
    --from-file=cluster2/root-cert.pem \
    --from-file=cluster2/cert-chain.pem
```

- Compare the CA root cert of two cluster

```
diff \
  <(kubectl --context="${CTX_CLUSTER1}" -n istio-system get secret cacerts -ojsonpath='{.data.ca-cert\.pem}')\
  <(kubectl --context="${CTX_CLUSTER2}" -n istio-system get secret cacerts -ojsonpath='{.data.ca-cert\.pem}')
```

### Install istio on multi-primary clusters running on different networks

[Istio - install multi-primary on different network](https://istio.io/latest/docs/setup/install/multicluster/multi-primary_multi-network/)  
[Istio - install multi-primary on the same network](https://istio.io/latest/docs/setup/install/multicluster/multi-primary/)  

- Config cluster1 as primary

```
cat <<EOF > cluster1.yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster1
      network: network1
EOF
  
istioctl install --context="${CTX_CLUSTER1}" -y -f cluster1.yaml
```
  
- Install the east-west gateway in cluster1

```samples/multicluster/gen-eastwest-gateway.sh --mesh mesh1 --cluster cluster1 --network network1 | istioctl --context="${CTX_CLUSTER1}" install -y -f - ```
  
- Expose services in cluster1

```kubectl --context="${CTX_CLUSTER1}" apply -n istio-system -f samples/multicluster/expose-services.yaml```

- Config cluster2 as primary

```
cat <<EOF > cluster2.yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster2
      network: network2
EOF
  
istioctl install --context="${CTX_CLUSTER1}" -y -f cluster2.yaml
```
  
- Install the east-west gateway in cluster2

```samples/multicluster/gen-eastwest-gateway.sh --mesh mesh1 --cluster cluster2 --network network2 | istioctl --context="${CTX_CLUSTER2}" install -y -f - ```
  
- Expose services in cluster2

```kubectl --context="${CTX_CLUSTER2}" apply -n istio-system -f samples/multicluster/expose-services.yaml```
  
- Enable Endpoint Discovery

```
istioctl x create-remote-secret --context="${CTX_CLUSTER1}" --name=cluster1 | kubectl apply -f - --context="${CTX_CLUSTER2}"
istioctl x create-remote-secret --context="${CTX_CLUSTER2}" --name=cluster2 | kubectl apply -f - --context="${CTX_CLUSTER1}"
```

### Observibility the Multi Custer Service Mesh

- Kiali setup

Due to Multi Cluster Visibility [Issue](https://github.com/kiali/kiali/issues/4670#issuecomment-1020709655) , need to modify Kiali yaml then deploy

- Add **Annotation (kiali.io/external-url: Ingress-URL)** in service as below

```
  annotations:
    kiali.io/external-url: http://kiali.172.25.80.177.nip.io/
```

- Add **web_fqdn: kiali-Ingress-Host** & **web_schema: http** in configmap as below
 
 ```
    server:
      metrics_enabled: true
      metrics_port: 9090
      port: 20001
      web_fqdn: kiali.172.25.80.177.nip.io
      web_root: /kiali
      web_schema: http
 ```

```kubectl apply -f $PWD/istio-1.10.1/samples/addons/kiali.yaml```

- Prometheus & Grafana setup

```
kubectl apply -f $PWD/istio-1.10.1/samples/addons/prometheus.yaml
kubectl apply -f $PWD/istio-1.10.1/samples/addons/grafana.yaml
```

- Jaeger setup

```kubectl apply -f $PWD/istio-1.10.1/samples/addons/jaeger.yaml```

### Verify the mesh service discovery and cross-cluster traffic
 
[Istio - verify installation](https://istio.io/latest/docs/setup/install/multicluster/verify/)  
[Istio - Troubleshooting Multicluster](https://istio.io/latest/docs/ops/diagnostic-tools/multicluster/)  

- Create the *sample* namespace, *helloworld* service and *sleep* deployment in both clusters

```
kubectl create --context="${CTX_CLUSTER1}" namespace sample
kubectl create --context="${CTX_CLUSTER2}" namespace sample

kubectl label --context="${CTX_CLUSTER1}" namespace sample istio-injection=enabled
kubectl label --context="${CTX_CLUSTER2}" namespace sample istio-injection=enabled

kubectl apply --context="${CTX_CLUSTER1}" -f samples/helloworld/helloworld.yaml -l service=helloworld -n sample    
kubectl apply --context="${CTX_CLUSTER2}" -f samples/helloworld/helloworld.yaml -l service=helloworld -n sample
    
kubectl apply --context="${CTX_CLUSTER1}" -f samples/sleep/sleep.yaml -n sample 
kubectl apply --context="${CTX_CLUSTER2}" -f samples/sleep/sleep.yaml -n sample
```
  
- Deploy Helloworld v1 into cluster1

```kubectl apply --context="${CTX_CLUSTER1}" -f samples/helloworld/helloworld.yaml -l version=v1 -n sample ```

- Deploy Helloworld v2 into cluster2

```kubectl apply --context="${CTX_CLUSTER2}" -f samples/helloworld/helloworld.yaml -l version=v2 -n sample ```
  
- Test the *hellowworld service* in cluster1 

While you test it repeatly, you should get return from both v1 running on cluster1 and v2 running on cluster2

```
kubectl exec --context="${CTX_CLUSTER1}" -n sample -c sleep \
  "$(kubectl get pod --context="${CTX_CLUSTER1}" -n sample -l \
  app=sleep -o jsonpath='{.items[0].metadata.name}')" \
  -- curl -sS helloworld.sample:5000/hello
```

- And do the same for cluster2

```
kubectl exec --context="${CTX_CLUSTER2}" -n sample -c sleep \
  "$(kubectl get pod --context="${CTX_CLUSTER2}" -n sample -l \
  app=sleep -o jsonpath='{.items[0].metadata.name}')" \
  -- curl -sS helloworld.sample:5000/hello
```

### Troubleshooting

```
istioctl pc ep "$(kubectl get pod --context="${CTX_CLUSTER1}" -n sample -l app=sleep -o jsonpath='{.items[0].metadata.name}')" -n sample --context="${CTX_CLUSTER1}" 
istioctl pc ep "$(kubectl get pod --context="${CTX_CLUSTER2}" -n sample -l app=sleep -o jsonpath='{.items[0].metadata.name}')" -n sample --context="${CTX_CLUSTER2}" 
```

### Check the istio-proxy sidecar config

```
kubectl config get-contexts
istioctl --context admin@cluster1 ps
kubectl --context admin@cluster1 get pod --namespace sample --output wide
kubectl --context admin@cluster2 get service --namespace istio-system
istioctl --context admin@cluster1 pc ep sleep-557747455f-4c7vz.sample --cluster="outbound|5000||helloworld.sample.svc.cluster.local"

kubectl config get-contexts
istioctl --context admin@cluster2 ps
kubectl --context admin@cluster2 get pod --namespace sample --output wide
kubectl --context admin@cluster1 get service --namespace istio-system
istioctl --context admin@cluster2 pc ep sleep-557747455f-jznfb.sample --cluster="outbound|5000||helloworld.sample.svc.cluster.local"
```

[Ref#1](https://blog.yugabyte.com/multi-region-yugabytedb-deployments-on-kubernetes-with-istio/0)

[Ref#2](https://github.com/cloudcafetech/setup-istio-multi-primary-diff-network/edit/main/README.md)
